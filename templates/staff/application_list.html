{% extends 'followup/new_base.html' %}
{% load static %}

{% block title %}Staff Dashboard - Student Applications{% endblock %}

{% block content %}

<!-- External Libraries (Keeping xlsx for export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <!-- Sidebar: Filters -->
    <aside class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 sticky top-24">
            <div class="flex items-center gap-2 mb-6">
                <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                    <i class="fas fa-filter"></i>
                </div>
                <h2 class="text-lg font-bold text-gray-900">Filters</h2>
            </div>

            <form method="GET" id="filterForm" class="flex flex-col gap-5">
                <input type="hidden" name="search" value="{{ request.GET.search|default:'' }}">

                <!-- Level Filter -->
                <div>
                    <label for="level" class="block text-sm font-semibold text-gray-700 mb-1.5">Level</label>
                    <select name="level" id="level"
                        class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all">
                        <option value="">All Levels</option>
                        <option value="ug" {% if request.GET.level == "ug" %}selected{% endif %}>UG</option>
                        <option value="pg" {% if request.GET.level == "pg" %}selected{% endif %}>PG</option>
                        <option value="le" {% if request.GET.level == "le" %}selected{% endif %}>LE</option>
                    </select>
                </div>

                <!-- Board Filter -->
                <div>
                    <label for="board" class="block text-sm font-semibold text-gray-700 mb-1.5">Board</label>
                    <select name="board" id="board"
                        class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all">
                        <option value="">All Boards</option>
                        <option value="State Board" {% if request.GET.board == "State Board" %}selected{% endif %}>State
                            Board</option>
                        <option value="CBSE" {% if request.GET.board == "CBSE" %}selected{% endif %}>CBSE</option>
                        <option value="ICSE" {% if request.GET.board == "ICSE" %}selected{% endif %}>ICSE</option>
                        <option value="Matriculation" {% if request.GET.board == "Matriculation" %}selected{% endif %}>
                            Matriculation</option>
                        <option value="Diploma" {% if request.GET.board == "Diploma" %}selected{% endif %}>Diploma
                        </option>
                        <option value="Others" {% if request.GET.board == "Others" %}selected{% endif %}>Others</option>
                    </select>
                </div>

                <!-- Department Filter -->
                <div>
                    <label for="dept" class="block text-sm font-semibold text-gray-700 mb-1.5">Department</label>
                    <select name="dept" id="dept"
                        class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all">
                        <option value="">All Departments</option>
                        <optgroup label="UG Departments">
                            <option value="B.TECH (AI & DS) - Artificial Intelligence and Data Science" {% if dept_filter == "B.TECH (AI & DS) - Artificial Intelligence and Data Science" %}selected{% endif %}>B.TECH AI & DS</option>
                            <option value="B.TECH (IT) - Information Technology" {% if dept_filter == "B.TECH (IT) - Information Technology" %}selected{% endif %}>B.TECH IT
                            </option>
                            <option value="B.TECH (CH) - Chemical Engineering" {% if dept_filter == "B.TECH (CH) - Chemical Engineering" %}selected{% endif %}>B.TECH Chemical
                            </option>
                            <option value="B.TECH (AE) - Agricultural Engineering" {% if dept_filter == "B.TECH (AE) - Agricultural Engineering" %}selected{% endif %}>B.TECH
                                Agricultural
                            </option>
                            <option value="B.TECH (BT) - Bio Technology" {% if dept_filter == "B.TECH (BT) - Bio Technology" %}selected{% endif %}>B.TECH Bio Tech
                            </option>
                            <option value="B.E (ME) - Mechanical Engineering (Tamil Medium)" {% if dept_filter == "B.E (ME) - Mechanical Engineering (Tamil Medium)" %}selected{% endif %}>
                                B.E Mech (Tamil)</option>
                            <option value="B.E (ME) - Mechanical Engineering (English Medium)" {% if dept_filter == "B.E (ME) - Mechanical Engineering (English Medium)" %}selected{% endif %}>
                                B.E Mech (English)</option>
                            <option value="B.E (BME) - Biomedical Engineering" {% if dept_filter == "B.E (BME) - Biomedical Engineering" %}selected{% endif %}>B.E Biomedical
                            </option>
                            <option value="B.E (CSE(IOT)) - Computer Science and Engineering (Internet Of Things)" {% if dept_filter == "B.E (CSE(IOT)) - Computer Science and Engineering (Internet Of Things)" %}selected{% endif %}>B.E CSE (IoT)</option>
                            <option value="B.E (CSE) - Computer Science and Engineering" {% if dept_filter == "B.E (CSE) - Computer Science and Engineering" %}selected{% endif %}>B.E CSE
                            </option>
                            <option value="B.E (CSD) - Computer Science and Design" {% if dept_filter == "B.E (CSD) - Computer Science and Design" %}selected{% endif %}>B.E CSD
                            </option>
                            <option value="B.E (CSE(AI & ML)) - Computer Science and Engineering (AI & ML)" {% if dept_filter == "B.E (CSE(AI & ML)) - Computer Science and Engineering (AI & ML)" %}selected{% endif %}>B.E CSE (AI & ML)</option>
                            <option value="B.E (CSE(CS)) - Computer Science and Engineering (Cyber Security)" {% if dept_filter == "B.E (CSE(CS)) - Computer Science and Engineering (Cyber Security)" %}selected{% endif %}>B.E CSE (Cyber Sec)</option>
                            <option value="B.E (ECE) - Electronics and Communication Engineering" {% if dept_filter == "B.E (ECE) - Electronics and Communication Engineering" %}selected{% endif %}>B.E ECE</option>
                            <option value="B.E (CE) - Civil Engineering" {% if dept_filter == "B.E (CE) - Civil Engineering" %}selected{% endif %}>B.E Civil</option>
                            <option value="B.E (EEE) - Electrical and Electronics Engineering" {% if dept_filter == "B.E (EEE) - Electrical and Electronics Engineering" %}selected{% endif %}>B.E EEE</option>
                            <option value="B.E (RAE) - Robotics & Automation" {% if dept_filter == "B.E (RAE) - Robotics & Automation" %}selected{% endif %}>B.E Robotics
                            </option>
                            <option value="B.E (EIE) - Electronics and Instrumentation Engineering" {% if dept_filter == "B.E (EIE) - Electronics and Instrumentation Engineering" %}selected{% endif %}>B.E EIE</option>
                        </optgroup>
                        <optgroup label="PG Departments">
                            <option value="MBA" {% if dept_filter == "MBA" %}selected{% endif %}>MBA</option>
                            <option value="MCA" {% if dept_filter == "MCA" %}selected{% endif %}>MCA</option>
                            <option value="M.E. Computer Science" {% if dept_filter == "M.E. Computer Science" %}selected{% endif %}>M.E. Computer Science</option>
                            <option value="M.E. Applied Electronics" {% if dept_filter == "M.E. Applied Electronics" %}selected{% endif %}>M.E. Applied Electronics</option>
                            <option value="M.E. Manufacturing Engineering" {% if dept_filter == "M.E. Manufacturing Engineering" %}selected{% endif %}>M.E. Manufacturing Engineering</option>
                            <option value="M.E. Environmental Engineering" {% if dept_filter == "M.E. Environmental Engineering" %}selected{% endif %}>M.E. Environmental Engineering</option>
                            <option value="M.E. Power Electronics and Drives" {% if dept_filter == "M.E. Power Electronics and Drives" %}selected{% endif %}>M.E. Power Electronics and Drives</option>
                            <option value="M.E. Industrial Safety Engineering" {% if dept_filter == "M.E. Industrial Safety Engineering" %}selected{% endif %}>M.E. Industrial Safety Engineering</option>
                            <option value="M.E. Structural Engineering" {% if dept_filter == "M.E. Structural Engineering" %}selected{% endif %}>M.E. Structural Engineering</option>
                            <option value="M.TECH (CH) - Chemical Engineering" {% if dept_filter == "M.TECH (CH) - Chemical Engineering" %}selected{% endif %}>M.TECH (CH) - Chemical Engineering</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Preference & Community (Horizontal) -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="preference"
                            class="block text-sm font-semibold text-gray-700 mb-1.5">Preference</label>
                        <select name="preference" id="preference"
                            class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all">
                            <option value="">All</option>
                            <option value="1" {% if pref_filter == "1" %}selected{% endif %}>1st</option>
                            <option value="2" {% if pref_filter == "2" %}selected{% endif %}>2nd</option>
                            <option value="3" {% if pref_filter == "3" %}selected{% endif %}>3rd</option>
                            <option value="3+" {% if pref_filter == "3+" %}selected{% endif %}>3+</option>
                        </select>
                    </div>
                    <div>
                        <label for="community"
                            class="block text-sm font-semibold text-gray-700 mb-1.5">Community</label>
                        <select name="community" id="community"
                            class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all">
                            <option value="">All</option>
                            <option value="OC" {% if request.GET.community == "OC" %}selected{% endif %}>OC</option>
                            <option value="BC" {% if request.GET.community == "BC" %}selected{% endif %}>BC</option>
                            <option value="MBC" {% if request.GET.community == "MBC" %}selected{% endif %}>MBC</option>
                            <option value="DNC" {% if request.GET.community == "DNC" %}selected{% endif %}>DNC</option>
                            <option value="BCM" {% if request.GET.community == "BCM" %}selected{% endif %}>BCM</option>
                            <option value="SC" {% if request.GET.community == "SC" %}selected{% endif %}>SC</option>
                            <option value="SCA" {% if request.GET.community == "SCA" %}selected{% endif %}>SCA</option>
                            <option value="ST" {% if request.GET.community == "ST" %}selected{% endif %}>ST</option>
                        </select>
                    </div>
                </div>

                <!-- Hostel & Transport Filter -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Hostel & Transport</label>
                    <select name="accommodation_type"
                        class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all">
                        <option value="">All</option>
                        <option value="hostel" {% if request.GET.accommodation_type == "hostel" %}selected{% endif %}>
                            Hostel</option>
                        <option value="transport" {% if request.GET.accommodation_type == "transport" %}selected{% endif %}>Transport</option>
                        <option value="not_needed" {% if request.GET.accommodation_type == "not_needed" %}selected{% endif %}>Not needed</option>
                    </select>
                </div>

                <!-- Cutoff Range (Horizontal) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Cutoff Range</label>
                    <div class="flex items-center gap-2">
                        <input type="number"
                            class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all"
                            name="cutoff_from" placeholder="From" value="{{ request.GET.cutoff_from|default:'' }}"
                            step="0.01">
                        <span class="text-gray-400 text-xs">to</span>
                        <input type="number"
                            class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all"
                            name="cutoff_to" placeholder="To" value="{{ request.GET.cutoff_to|default:'' }}"
                            step="0.01">
                    </div>
                </div>

                <!-- Application Date Range (Horizontal) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Application Date</label>
                    <div class="flex flex-col gap-2">
                        <input type="date" name="date_from"
                            class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all"
                            value="{{ request.GET.date_from|default:'' }}">
                        <input type="date" name="date_to"
                            class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all"
                            value="{{ request.GET.date_to|default:'' }}">
                    </div>
                </div>

                <!-- Sorting -->
                <div>
                    <label for="sort" class="block text-sm font-semibold text-gray-700 mb-1.5">Sort By</label>
                    <select name="sort" id="sort"
                        class="w-full rounded-xl border-gray-200 text-sm focus:border-primary focus:ring-primary transition-all">
                        <option value="-created_at" {% if request.GET.sort == "-created_at" or not request.GET.sort %}selected{% endif %}>Latest First</option>
                        <option value="created_at" {% if request.GET.sort == "created_at" %}selected{% endif %}>Oldest First</option>
                        <option value="-cutoff_marks" {% if request.GET.sort == "-cutoff_marks" %}selected{% endif %}>Cutoff (H-L)</option>
                        <option value="cutoff_marks" {% if request.GET.sort == "cutoff_marks" %}selected{% endif %}>Cutoff (L-H)</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="pt-4 flex flex-col gap-2">
                    <button type="submit"
                        class="w-full bg-primary text-white font-bold py-2.5 rounded-xl hover:bg-primary/90 transition-all shadow-sm">
                        Apply Filters
                    </button>
                    <button type="button" onclick="clearFilters()"
                        class="w-full bg-gray-100 text-gray-600 font-bold py-2.5 rounded-xl hover:bg-gray-200 transition-all">
                        Clear All
                    </button>
                </div>
            </form>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="lg:col-span-3 space-y-6">
        <!-- Stats & Search Header -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Student Applications</h1>
                    <p class="text-sm text-gray-500 font-medium">Manage and track student admission requests</p>
                </div>
                <div class="bg-dark rounded-2xl p-4 text-white flex items-center gap-4 min-w-[220px]">
                    <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center text-xl">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <span class="text-xs font-bold uppercase tracking-widest opacity-70">Total Apps</span>
                        <span class="block text-2xl font-black leading-none mt-1">{{ page_obj.paginator.count }}</span>
                    </div>
                </div>
            </div>

            <!-- Enhanced Search -->
            <form method="GET" class="relative group">
                <div
                    class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-primary transition-colors">
                    <i class="fas fa-search text-sm"></i>
                </div>
                <input type="text" name="search"
                    class="w-full pl-10 pr-36 py-4 bg-gray-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-primary/20 transition-all font-medium"
                    placeholder="Search by name, email, register number, or application number..."
                    value="{{ request.GET.search|default:'' }}">
                <button type="submit"
                    class="absolute right-2 top-2 bottom-2 bg-primary text-white px-8 rounded-xl font-bold text-sm hover:bg-primary/90 transition-all shadow-sm">
                    Search
                </button>
            </form>
        </div>

        <!-- Export Tools & Count -->
        <div
            class="flex flex-col sm:flex-row justify-between items-center bg-white rounded-2xl shadow-sm border border-gray-100 p-4 gap-4">
            <div class="flex items-center gap-2">
                <a href="{% url 'export_applications' %}"
                    class="flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-700 rounded-xl text-xs font-bold hover:bg-emerald-100 transition-all border border-emerald-200/50">
                    <i class="fas fa-file-excel"></i> Export All Applications
                </a>

            </div>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">
                Showing <span class="text-gray-900">{{ page_obj.start_index }}</span> - <span class="text-gray-900">{{page_obj.end_index }}</span> of <span class="text-gray-900">{{ page_obj.paginator.count }}</span>
            </p>
        </div>

        <!-- Applications Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50/50 border-b border-gray-100">
                            <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">App
                                No.</th>
                            <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">
                                Student Details</th>
                            <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Level
                            </th>
                            <th
                                class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] text-center">
                                Cutoff</th>
                            <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">1st
                                Preference</th>
                            <th
                                class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] text-center">
                                Status</th>
                            <th
                                class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] text-center">
                                Admission Status</th>
                            <th
                                class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] text-right">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for admission in page_obj %}
                        <tr class="hover:bg-gray-50/50 transition-all group">
                            <td class="px-6 py-4">
                                <span class="text-sm font-bold text-gray-900">{{ admission.application_number|default:"N/A" }}</span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col">
                                    <span
                                        class="text-sm font-bold text-gray-900 group-hover:text-primary transition-colors">{{ admission.student_name }}</span>
                                    <span class="text-[11px] font-semibold text-gray-400">{{admission.register_number|default:"No Reg No." }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span
                                    class="inline-flex px-2 py-1 rounded-lg text-[9px] font-black uppercase tracking-wider
                                    {% if admission.level == 'ug' %}bg-sky-50 text-sky-600{% elif admission.level == 'pg' %}bg-emerald-50 text-emerald-600{% else %}bg-amber-50 text-amber-600{% endif %} font-mono">
                                    {{ admission.level }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="text-sm font-black text-dark">{{ admission.cutoff_marks|default:"N/A" }}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-[11px] font-bold text-gray-600 line-clamp-1  uppercase"
                                    title="{{ admission.first_preference_dept }}">
                                    {{ admission.branch|default:"N/A" }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span
                                    class="inline-flex px-2 py-1 rounded-lg text-[9px] font-black uppercase tracking-wider
                                    {% if admission.had_paid %}bg-emerald-50 text-emerald-600{% else %}bg-amber-50 text-amber-600{% endif %} font-mono">
                                    {% if admission.had_paid %}Paid{% else %}Pending{% endif %}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <select onchange="updateAdmissionStatus(this, '{{ admission.pk }}')" class="text-xs font-bold rounded-lg border-gray-200 focus:border-primary focus:ring-primary py-1 pl-2 pr-8
                                    {% if admission.admission_status == 'admitted' %}bg-green-50 text-green-700 border-green-200
                                    {% elif admission.admission_status == 'discontinued' %}bg-red-50 text-red-700 border-red-200
                                    {% else %}bg-blue-50 text-blue-700 border-blue-200{% endif %}">
                                    <option value="enquired" {% if admission.admission_status == 'enquired' %}selected{% endif %}>Enquired</option>
                                    <option value="admitted" {% if admission.admission_status == 'admitted' %}selected{% endif %}>Admitted</option>
                                    <option value="discontinued" {% if admission.admission_status == 'discontinued' %}selected{% endif %}>Discontinued</option>
                                </select>
                            </td>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex justify-end gap-1.5">
                                    <a href="{% url 'student_detail' admission.pk %}"
                                        class="w-8 h-8 rounded-lg bg-gray-50 flex items-center justify-center text-gray-400 hover:bg-primary hover:text-white transition-all shadow-sm">
                                        <i class="fas fa-eye text-[10px]"><svg xmlns="http://www.w3.org/2000/svg"
                                                width="20" height="20" viewBox="0 0 20 20">
                                                <g fill="currentColor">
                                                    <path fill-rule="evenodd"
                                                        d="M10 16c4.658 0 8.5-2.161 8.5-5S14.658 6 10 6s-8.5 2.161-8.5 5s3.842 5 8.5 5m0-9c4.179 0 7.5 1.868 7.5 4s-3.321 4-7.5 4s-7.5-1.868-7.5-4S5.821 7 10 7"
                                                        clip-rule="evenodd" />
                                                    <path
                                                        d="M9.5 3.5a.5.5 0 0 1 1 0v3a.5.5 0 0 1-1 0zm4.01.402a.5.5 0 0 1 .98.196l-.5 2.5a.5.5 0 0 1-.98-.196zm-7.02 0a.5.5 0 0 0-.98.196l.5 2.5a.5.5 0 0 0 .98-.196zM2.429 5.243a.5.5 0 0 0-.858.514l1.5 2.5a.5.5 0 0 0 .858-.514zm15.142 0a.5.5 0 1 1 .858.514l-1.5 2.5a.5.5 0 1 1-.858-.514zM13 10.5a3 3 0 1 1-6 0a3 3 0 0 1 6 0" />
                                                </g>
                                            </svg></i>
                                    </a>
                                    <a href="{% url 'review' admission.pk %}?edit=true"
                                        class="w-8 h-8 rounded-lg bg-gray-50 flex items-center justify-center text-gray-400 hover:bg-dark hover:text-white transition-all shadow-sm">
                                        <i class="fas fa-edit text-[10px]"><svg xmlns="http://www.w3.org/2000/svg"
                                                width="20" height="20" viewBox="0 0 20 20">
                                                <g fill="currentColor">
                                                    <path fill-rule="evenodd"
                                                        d="M16.324 6.717a2.5 2.5 0 0 0-3.535-3.535l-8.975 8.975l-.112.17c-.165.417-.366.827-.865 1.797c-1.255 2.436-1.455 2.935-.923 3.468c.533.533 1.032.332 3.468-.923c.97-.5 1.38-.7 1.798-.865l.17-.112zm-.707-2.828a1.5 1.5 0 0 1 0 2.121l-8.903 8.903c-.426.174-.858.387-1.79.867c-.95.49-1.351.687-1.766.853a4 4 0 0 1-.435.15q.046-.178.15-.435c.166-.414.364-.816.853-1.766c.48-.932.693-1.364.867-1.79l8.903-8.903a1.5 1.5 0 0 1 2.121 0"
                                                        clip-rule="evenodd" />
                                                    <path
                                                        d="M9.851 3.824a.5.5 0 0 1 .707-.707l5.657 5.657a.5.5 0 1 1-.707.707z" />
                                                </g>
                                            </svg></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="px-6 py-24 text-center">
                                <div class="flex flex-col items-center gap-4">
                                    <div
                                        class="w-20 h-20 rounded-3xl bg-gray-50 flex items-center justify-center text-gray-200 text-3xl">
                                        <i class="fas fa-inbox"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900">No Applications Found</h3>
                                        <p class="text-sm text-gray-500 max-w-xs mx-auto">We couldn't find any results
                                            matching your current filters or search query.</p>
                                    </div>
                                    <a href="{% url 'student_applications_list' %}"
                                        class="px-6 py-2 bg-primary text-white text-xs font-black uppercase tracking-widest rounded-xl hover:bg-primary/90 transition-all">Clear
                                        All Filters</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-sm text-gray-600">
                    Page <span class="font-bold text-gray-900">{{ page_obj.number }}</span> of <span
                        class="font-bold text-gray-900">{{ page_obj.paginator.num_pages }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Previous Button -->
                    {% if page_obj.has_previous %}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}"
                        class="px-4 py-2 bg-gray-50 text-gray-700 rounded-xl text-sm font-bold hover:bg-gray-100 transition-all border border-gray-200 flex items-center gap-2">
                        <i class="fas fa-chevron-left text-xs"></i>
                        Previous
                    </a>
                    {% else %}
                    <button disabled
                        class="px-4 py-2 bg-gray-50 text-gray-400 rounded-xl text-sm font-bold border border-gray-200 flex items-center gap-2 cursor-not-allowed">
                        <i class="fas fa-chevron-left text-xs"></i>
                        Previous
                    </button>
                    {% endif %}

                    <!-- Page Numbers -->
                    <div class="flex items-center gap-1">
                        {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number  ==  num %}
                        <span
                            class="w-10 h-10 bg-primary text-white rounded-xl text-sm font-bold flex items-center justify-center">{{ num }}</span>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <a
                            href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}"
                            class="w-10 h-10 bg-gray-50 text-gray-700 rounded-xl text-sm font-bold hover:bg-gray-100 transition-all flex items-center justify-center">
                            {{ num }}</a>
                            {% elif num  ==  page_obj.paginator.page_range.0 or num  ==  page_obj.paginator.page_range.last %}
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}"
                                class="w-10 h-10 bg-gray-50 text-gray-700 rounded-xl text-sm font-bold hover:bg-gray-100 transition-all flex items-center justify-center">{{
                                num }}</a>
                            {% elif num  ==  page_obj.number|add:'-4' or num  ==  page_obj.number|add:'4' %}
                            <span
                                class="w-10 h-10 bg-gray-50 text-gray-400 rounded-xl text-sm font-bold flex items-center justify-center">...</span>
                            {% endif %}
                            {% endfor %}
                    </div>

                    <!-- Next Button -->
                    {% if page_obj.has_next %}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}"
                        class="px-4 py-2 bg-gray-50 text-gray-700 rounded-xl text-sm font-bold hover:bg-gray-100 transition-all border border-gray-200 flex items-center gap-2">
                        Next
                        <i class="fas fa-chevron-right text-xs"></i>
                    </a>
                    {% else %}
                    <button disabled
                        class="px-4 py-2 bg-gray-50 text-gray-400 rounded-xl text-sm font-bold border border-gray-200 flex items-center gap-2 cursor-not-allowed">
                        Next
                        <i class="fas fa-chevron-right text-xs"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Admission Modal -->
<div id="admissionModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

        <!-- This element is to trick the browser into centering the modal contents. -->
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <!-- Modal panel -->
        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-user-graduate text-green-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Confirm Admission
                        </h3>
                        <div class="mt-2 text-sm text-gray-500">
                            <p>Please select the allocated Course and Branch for this student.</p>
                        </div>

                        <!-- Form Fields -->
                        <div class="mt-4 space-y-4">
                            <div>
                                <label for="modalCourse" class="block text-sm font-medium text-gray-700">Course</label>
                                <select id="modalCourse"
                                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                                    <option value="" disabled selected>Select Course</option>
                                    <option value="Course 1">Course 1</option>
                                    <option value="Course 2">Course 2</option>
                                    <option value="Course 3">Course 3</option>
                                </select>
                            </div>
                            <div>
                                <label for="modalBranch" class="block text-sm font-medium text-gray-700">Branch</label>
                                <select id="modalBranch"
                                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                                    <option value="" disabled selected>Select Branch</option>
                                    <option value="Branch 1">Branch 1</option>
                                    <option value="Branch 2">Branch 2</option>
                                    <option value="Branch 3">Branch 3</option>
                                </select>
                            </div>
                            <div id="modalError" class="text-red-500 text-xs hidden">Please select both Course and
                                Branch.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmAdmissionBtn"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm">
                    Confirm Admission
                </button>
                <button type="button" id="cancelAdmissionBtn"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>


<script>
    let currentAdmissionId = null;
    let currentSelectElement = null;
    let originalStatusValue = null;

    // Clear filters function
    function clearFilters() {
        const form = document.getElementById('filterForm');
        const inputs = form.querySelectorAll('select, input');
        inputs.forEach(input => {
            if (input.type !== 'hidden') {
                input.value = '';
            }
        });
        form.submit();
    }

    // Auto-submit form when certain filters change
    document.addEventListener('DOMContentLoaded', function () {
        const autoSubmitFilters = ['level', 'board', 'community', 'sort', 'preference', 'accommodation_type'];
        autoSubmitFilters.forEach(filter => {
            const element = document.getElementById(filter);
            if (element) {
                element.addEventListener('change', function () {
                    document.getElementById('filterForm').submit();
                });
            }
        });

        // Modal Event Listeners
        document.getElementById('cancelAdmissionBtn').addEventListener('click', closeAdmissionModal);
        document.getElementById('confirmAdmissionBtn').addEventListener('click', submitAdmission);
    });

    function updateAdmissionStatus(selectElement, admissionId) {
        const newStatus = selectElement.value;
        const originalStatus = selectElement.getAttribute('data-original-status') || 'enquired';

        // Store references
        currentAdmissionId = admissionId;
        currentSelectElement = selectElement;
        originalStatusValue = originalStatus;

        if (newStatus === 'admitted') {
            // Show Modal
            const modal = document.getElementById('admissionModal');
            modal.classList.remove('hidden');
            // Reset modal fields
            document.getElementById('modalCourse').value = '';
            document.getElementById('modalBranch').value = '';
            document.getElementById('modalError').classList.add('hidden');
            return; // Stop here, wait for modal confirmation
        }

        // Proceed with normal update for other statuses
        performStatusUpdate(newStatus, null, null);
    }

    function closeAdmissionModal() {
        const modal = document.getElementById('admissionModal');
        modal.classList.add('hidden');
        // Revert select to original status
        if (currentSelectElement) {
            currentSelectElement.value = originalStatusValue;
            // Also revert colors if needed, but since we didn't change them yet in this flow (except for 'admitted' logic which we are intercepting), 
            // we should probably just re-apply the correct class for the original status.
            updateSelectColor(currentSelectElement, originalStatusValue);
        }
        currentAdmissionId = null;
        currentSelectElement = null;
    }

    function submitAdmission() {
        const course = document.getElementById('modalCourse').value;
        const branch = document.getElementById('modalBranch').value;

        if (!course || !branch) {
            document.getElementById('modalError').classList.remove('hidden');
            return;
        }

        performStatusUpdate('admitted', course, branch);

        // Hide modal
        document.getElementById('admissionModal').classList.add('hidden');
    }

    function updateSelectColor(element, status) {
        element.classList.remove('bg-green-50', 'text-green-700', 'border-green-200',
            'bg-red-50', 'text-red-700', 'border-red-200',
            'bg-blue-50', 'text-blue-700', 'border-blue-200');

        if (status === 'admitted') {
            element.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
        } else if (status === 'discontinued') {
            element.classList.add('bg-red-50', 'text-red-700', 'border-red-200');
        } else {
            element.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-200');
        }
    }

    function performStatusUpdate(newStatus, course, branch) {
        const selectElement = currentSelectElement;
        const admissionId = currentAdmissionId;
        const originalStatus = originalStatusValue;

        // Visual feedback immediately
        selectElement.disabled = true;

        updateSelectColor(selectElement, newStatus);

        const payload = {
            status: newStatus
        };
        if (course) payload.course = course;
        if (branch) payload.branch = branch;

        fetch(`/staff/applications/update-status/${admissionId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                selectElement.disabled = false;
                if (data.status === 'success') {
                    // Update original status attribute to new status
                    selectElement.setAttribute('data-original-status', newStatus);
                    // Optional: Show a toast notification
                    // alert('Status updated successfully');
                } else {
                    alert('Failed to update status: ' + data.message);
                    // Revert visual changes
                    selectElement.value = originalStatus;
                    updateSelectColor(selectElement, originalStatus);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                selectElement.disabled = false;
                alert('An error occurred while updating status');
                // Revert changes
                selectElement.value = originalStatus;
                updateSelectColor(selectElement, originalStatus);
            });
    }
</script>
{% endblock %}